---
resources:
- name: garagepi
  type: git
  source:
    uri: git@github.com:robdimsdale/garagepi
    branch: develop
    private_key: {{private-key}}

- name: garagepi-master
  type: git
  source:
    uri: git@github.com:robdimsdale/garagepi
    branch: master
    private_key: {{private-key}}

- name: slack-alert
  type: slack-notification
  source:
    url: {{slack-url}}

- name: version
  type: semver
  source:
    bucket: garagepi-releases
    key: current-version
    access_key_id: {{pipeline-bucket-access-key}}
    secret_access_key: {{pipeline-bucket-secret-key}}

jobs:
- name: tests
  public: false
  plan:
  - do:
    - aggregate:
      - get: version
        params: {bump: minor, pre: rc}
      - get: garagepi
        trigger: true
    - task: tests
      file: garagepi/scripts/ci/tests.yml
    - put: version
      params: {file: version/number}
    on_success:
      put: slack-alert
      params:
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-success-text}}
    on_failure:
      put: slack-alert
      params:
        username: concourse
        icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
        channel: {{slack-channel}}
        text: {{slack-failure-text}}

- name: shipit
  serial: true
  plan:
  - aggregate:
    - get: garagepi
      passed: [tests]
      params: {fetch: [master]}
    - get: version
      passed: [tests]
      params: {bump: final}
  - aggregate:
    - put: version
      params: {file: version/number}
    - put: garagepi-master
      params:
        repository: garagepi
        tag: version/number
        tag_prefix: v
